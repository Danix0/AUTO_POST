name: Refresh Epic Token
on:
  workflow_dispatch:
  schedule:
    # “At 13:37 on every day-of-week from Monday through Friday.”
    - cron: "0 */1 * * *"

permissions:
 actions: write
 contents: read
 
jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v4
      - name: Ustaw Node.js
        uses: actions/setup-node@v4 
        with: 
          node-version: 20

      - name: Zainstaluj zależności
        run: npm install node-fetch@3

      - name: Odczytaj aktualny timestamp
        id: get_var
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GH_PAT2 }}
        run: |
          response=$(curl -s -H "Authorization: Bearer $TOKEN" \
                         -H "Accept: application/vnd.github+json" \
                         https://api.github.com/repos/$REPO/actions/variables/LAST_RUN)
          last_run=$(echo "$response" | jq -r '.value // 0')
          echo "last_run=$last_run" >> $GITHUB_OUTPUT

      - name: Get current timestamp and calculate delta
        id: calc
        run: |
          now=$(date +%s)

          if [ -f last_run.txt ]; then
            last=$(cat last_run.txt)
          else
            last=0
          fi
          
          echo "now=$now" >> $GITHUB_OUTPUT
          echo "last=$last" >> $GITHUB_OUTPUT

          delta=$((now - last))
          echo "delta=$delta" >> $GITHUB_OUTPUT
          echo $now > last_run.txt

      - name: Check if enough time passed
        id: check
        run: |
          REQUIRED=$((45 * 3598))
          if [ ${{ steps.calc.outputs.delta }} -lt $REQUIRED ]; then
            echo "notyet=true" >> $GITHUB_OUTPUT
          else
            temp=1
            echo "LAST_RUN=$temp" >> $GITHUB_VARS
            echo "notyet=false" >> $GITHUB_OUTPUT
          fi
   
      - name: Exit if too early
        if: steps.check.outputs.notyet == 'true'
        run: echo "Za wcześnie → workflow kończy się."

      - name: Wykonaj refresh
        if: steps.check.outputs.notyet == 'false'
        env:
          REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
        run: node refresh.js

      - name: Zaktualizuj timestamp
        if: steps.check.outputs.notyet == 'false'
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GH_PAT2 }}
        run: |
          now=$(date +%s)
          curl -X PATCH \
               -H "Authorization: Bearer $TOKEN" \
               -H "Accept: application/vnd.github+json" \
               -H "Content-Type: application/json" \
               https://api.github.com/repos/$REPO/actions/variables/LAST_RUN \
               -d "{\"name\":\"LAST_RUN\",\"value\":\"$now\"}"
